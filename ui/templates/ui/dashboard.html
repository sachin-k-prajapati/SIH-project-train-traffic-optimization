<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Railway Control Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #1e3d59;
            --secondary-blue: #2e5266;
            --accent-green: #17c3b2;
            --accent-orange: #ff6b35;
            --accent-red: #dc3545;
            --accent-yellow: #ffc107;
            --light-gray: #f8f9fa;
            --dark-gray: #495057;
        }

        body {
            background: linear-gradient(135deg, var(--light-gray) 0%, #e9ecef 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 1rem 0;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: white !important;
        }

        .dashboard-header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
        }

        .system-status-bar {
            background: var(--accent-green);
            color: white;
            padding: 0.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-weight: 600;
            text-align: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            color: white;
            border: none;
            padding: 1rem 1.5rem;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .kpi-card {
            text-align: center;
            padding: 1.5rem;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .kpi-card:hover {
            transform: scale(1.05);
        }

        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }

        .kpi-label {
            color: var(--dark-gray);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
        }

        .kpi-change {
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .kpi-change.positive {
            color: var(--accent-green);
        }

        .kpi-change.negative {
            color: var(--accent-red);
        }

        .section-map {
            height: 400px;
            border-radius: 10px;
            border: 2px solid #dee2e6;
        }

        .train-card {
            border-left: 4px solid;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .train-card:hover {
            transform: translateX(5px);
        }

        .train-express {
            border-left-color: var(--accent-green);
        }

        .train-local {
            border-left-color: var(--accent-orange);
        }

        .train-freight {
            border-left-color: var(--dark-gray);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-on-time {
            background-color: var(--accent-green);
            animation: pulse-green 2s infinite;
        }

        .status-delayed {
            background-color: var(--accent-red);
            animation: pulse-red 2s infinite;
        }

        .status-early {
            background-color: var(--accent-yellow);
        }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(23, 195, 178, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(23, 195, 178, 0); }
            100% { box-shadow: 0 0 0 0 rgba(23, 195, 178, 0); }
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }

        .alert-panel {
            max-height: 300px;
            overflow-y: auto;
        }

        .alert-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .alert-high {
            background-color: #fff5f5;
            border-left-color: var(--accent-red);
            color: #721c24;
        }

        .alert-medium {
            background-color: #fffbf0;
            border-left-color: var(--accent-yellow);
            color: #8a6914;
        }

        .alert-low {
            background-color: #f0fff4;
            border-left-color: var(--accent-green);
            color: #22543d;
        }

        .weather-widget {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
        }

        .weather-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .progress-custom {
            height: 8px;
            border-radius: 10px;
            overflow: hidden;
        }

        .optimization-panel {
            background: linear-gradient(135deg, #a8e6cf 0%, #7fcdcd 100%);
            color: #2d3748;
            border-radius: 15px;
            padding: 1.5rem;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .spinner-border {
            color: var(--primary-blue);
        }

        .real-time-indicator {
            background: var(--accent-green);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            animation: pulse 2s infinite;
        }

        .segment-progress {
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .segment-progress-bar {
            height: 30px;
            background: linear-gradient(135deg, var(--accent-green) 0%, #27ae60 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            transition: width 1s ease;
        }

        @media (max-width: 768px) {
            .dashboard-header {
                padding: 1rem 0;
            }
            
            .kpi-value {
                font-size: 2rem;
            }
            
            .section-map {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="{% url 'ui:dashboard' %}">
                <i class="fas fa-train"></i> Railway Command Center
            </a>
            <div class="navbar-nav ms-auto">
                <span class="real-time-indicator">
                    <i class="fas fa-circle"></i> LIVE
                </span>
            </div>
        </div>
    </nav>

    <!-- System Status Bar -->
    <div class="container-fluid">
        <div class="system-status-bar" id="systemStatus">
            <i class="fas fa-check-circle"></i> All Systems Operational | Last Update: <span id="lastUpdate">--:--</span>
        </div>
    </div>

    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-1">
                        <i class="fas fa-tachometer-alt"></i>
                        Real-Time Railway Control Dashboard
                    </h1>
                    <p class="mb-0 opacity-75">
                        Advanced AI-Powered Traffic Management System
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="weather-widget">
                        <div class="weather-icon">
                            <i class="fas fa-sun" id="weatherIcon"></i>
                        </div>
                        <div id="weatherTemp">25Â°C</div>
                        <div id="weatherCondition">Clear Sky</div>
                        <div class="mt-2">
                            <small>Impact Factor: <span id="weatherImpact">1.0</span></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        {% if no_data %}
        <!-- No Data Available -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-database fa-3x text-muted mb-3"></i>
                        <h3 class="text-muted">No Railway Data Available</h3>
                        <p class="text-muted mb-4">
                            The system is ready but no railway sections have been configured yet.<br>
                            Please generate sample data to begin using the dashboard.
                        </p>
                        <a href="{% url 'ui:dashboard' %}?generate_data=1" class="btn btn-primary btn-lg">
                            <i class="fas fa-plus-circle"></i> Generate Sample Data
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="row">
            <!-- KPI Section -->
            <div class="col-12 mb-4">
                <div class="row">
                    <div class="col-md-2 col-6">
                        <div class="kpi-card">
                            <div class="kpi-value text-primary" id="activeTains">12</div>
                            <div class="kpi-label">Active Trains</div>
                            <div class="kpi-change positive" id="trainsChange">
                                <i class="fas fa-arrow-up"></i> +2 from last hour
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 col-6">
                        <div class="kpi-card">
                            <div class="kpi-value text-success" id="punctuality">94.2%</div>
                            <div class="kpi-label">Punctuality</div>
                            <div class="kpi-change positive" id="punctualityChange">
                                <i class="fas fa-arrow-up"></i> +1.5%
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 col-6">
                        <div class="kpi-card">
                            <div class="kpi-value text-warning" id="avgDelay">3.2</div>
                            <div class="kpi-label">Avg Delay (min)</div>
                            <div class="kpi-change negative" id="delayChange">
                                <i class="fas fa-arrow-down"></i> -0.8 min
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 col-6">
                        <div class="kpi-card">
                            <div class="kpi-value text-info" id="throughput">28.5</div>
                            <div class="kpi-label">Throughput</div>
                            <div class="kpi-change positive" id="throughputChange">
                                <i class="fas fa-arrow-up"></i> +5.2%
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 col-6">
                        <div class="kpi-card">
                            <div class="kpi-value text-success" id="efficiency">87.3%</div>
                            <div class="kpi-label">Fuel Efficiency</div>
                            <div class="kpi-change positive" id="efficiencyChange">
                                <i class="fas fa-arrow-up"></i> +2.1%
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 col-6">
                        <div class="kpi-card">
                            <div class="kpi-value text-danger" id="utilization">76.8%</div>
                            <div class="kpi-label">Capacity Used</div>
                            <div class="kpi-change positive" id="utilizationChange">
                                <i class="fas fa-arrow-up"></i> +8.2%
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-8">
                <!-- Section Map -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-map"></i> Live Section Overview
                        <button class="btn btn-sm btn-light float-end" onclick="refreshMap()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="sectionMap" class="section-map"></div>
                        
                        <!-- Segment Status -->
                        <div class="mt-3">
                            <h6>Segment Utilization</h6>
                            <div id="segmentStatus">
                                <div class="segment-progress">
                                    <div class="segment-progress-bar" style="width: 65%">
                                        Segment A: 65% occupied
                                    </div>
                                </div>
                                <div class="segment-progress">
                                    <div class="segment-progress-bar" style="width: 80%">
                                        Segment B: 80% occupied
                                    </div>
                                </div>
                                <div class="segment-progress">
                                    <div class="segment-progress-bar" style="width: 45%">
                                        Segment C: 45% occupied
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Optimization Panel -->
                <div class="card mt-4">
                    <div class="card-header">
                        <i class="fas fa-brain"></i> AI Optimization Engine
                    </div>
                    <div class="card-body">
                        <div class="optimization-panel">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-robot"></i> Current Algorithm</h6>
                                    <p class="mb-1">Advanced Multi-Objective ILP</p>
                                    <small class="text-muted">Last optimized: <span id="lastOptimized">2 minutes ago</span></small>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-chart-line"></i> Performance Metrics</h6>
                                    <p class="mb-1">Solve Time: <span id="solveTime">1.8s</span></p>
                                    <p class="mb-1">Confidence: <span id="confidence">High (98%)</span></p>
                                </div>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-primary btn-sm" onclick="runOptimization()">
                                    <i class="fas fa-play"></i> Run Optimization
                                </button>
                                <button class="btn btn-outline-primary btn-sm" onclick="viewRecommendations()">
                                    <i class="fas fa-lightbulb"></i> View Recommendations
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Active Trains -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-train"></i> Active Trains
                        <span class="badge bg-light text-dark float-end" id="activeTrainCount">12</span>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <div id="activeTrainsList">
                            <!-- Dynamic train list will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Alerts and Recommendations -->
                <div class="card mt-3">
                    <div class="card-header">
                        <i class="fas fa-exclamation-triangle"></i> Alerts & Recommendations
                        <span class="badge bg-danger float-end" id="alertCount">3</span>
                    </div>
                    <div class="card-body alert-panel">
                        <div id="alertsList">
                            <!-- Dynamic alerts will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Emergency Controls -->
                <div class="card mt-3">
                    <div class="card-header bg-danger text-white">
                        <i class="fas fa-exclamation-circle"></i> Emergency Controls
                    </div>
                    <div class="card-body">
                        <button class="btn btn-danger btn-sm w-100 mb-2" onclick="emergencyStop()">
                            <i class="fas fa-stop"></i> Emergency Stop All
                        </button>
                        <button class="btn btn-warning btn-sm w-100 mb-2" onclick="systemMaintenance()">
                            <i class="fas fa-tools"></i> Maintenance Mode
                        </button>
                        <button class="btn btn-info btn-sm w-100" onclick="weatherAlert()">
                            <i class="fas fa-cloud-rain"></i> Weather Alert
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="mt-2">Processing optimization...</div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // Global variables
        let map;
        let trainMarkers = {};
        let websocket;
        let optimizationChart;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            connectRealTimeDemo();
            updateTimestamp();
            loadActiveTrains();
            loadAlerts();
            setInterval(updateTimestamp, 1000);
            setInterval(refreshData, 5000); // Refresh every 5 seconds
        });

        // Initialize Leaflet map
        function initializeMap() {
            map = L.map('sectionMap').setView([28.6139, 77.2090], 12); // Delhi coordinates
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            // Add railway line
            const railwayLine = [
                [28.6139, 77.2090],
                [28.6289, 77.2170],
                [28.6439, 77.2250],
                [28.6589, 77.2330]
            ];

            L.polyline(railwayLine, {color: '#1e3d59', weight: 6}).addTo(map);

            // Add stations
            const stations = [
                {name: 'Station A', coords: [28.6139, 77.2090]},
                {name: 'Station B', coords: [28.6289, 77.2170]},
                {name: 'Station C', coords: [28.6439, 77.2250]},
                {name: 'Station D', coords: [28.6589, 77.2330]}
            ];

            stations.forEach(station => {
                L.marker(station.coords)
                    .addTo(map)
                    .bindPopup(`<b>${station.name}</b><br>Status: Operational`);
            });
        }

        // Simulated real-time connection for demo (replaces WebSocket for presentation)
        function connectRealTimeDemo() {
            console.log('ð Demo Real-Time System Connected');
            updateSystemStatus('Live Demo Mode - All Systems Operational', 'success');
            
            // Start simulated real-time updates
            startDemoUpdates();
        }

        // Start demo real-time updates
        function startDemoUpdates() {
            // Update train positions every 3 seconds
            setInterval(updateTrainPositions, 3000);
            
            // Update KPIs every 5 seconds  
            setInterval(updateKPIsDynamic, 5000);
            
            // Occasional alerts every 15 seconds
            setInterval(generateDemoAlerts, 15000);
            
            // Update weather every 30 seconds
            setInterval(updateWeatherDemo, 30000);
        }

        // Simulate train movement for demo
        function updateTrainPositions() {
            const trains = document.querySelectorAll('.train-card');
            trains.forEach((train, index) => {
                // Simulate position changes
                const speedElement = train.querySelector('.train-speed');
                if (speedElement) {
                    const newSpeed = Math.floor(Math.random() * 40) + 60; // 60-100 km/h
                    speedElement.textContent = `${newSpeed} km/h`;
                }
                
                // Add movement animation
                train.style.transform = `translateX(${Math.sin(Date.now() / 1000 + index) * 2}px)`;
            });
            
            console.log('ð Train positions updated');
        }

        // Dynamic KPI updates for impressive demo
        function updateKPIsDynamic() {
            // Throughput improvement
            const throughputEl = document.getElementById('throughput');
            if (throughputEl) {
                const current = parseFloat(throughputEl.textContent);
                const improvement = (Math.random() - 0.5) * 2; // Â±1
                const newValue = Math.max(15, Math.min(35, current + improvement));
                throughputEl.textContent = newValue.toFixed(1);
                
                // Show improvement effect
                throughputEl.style.color = improvement > 0 ? '#17c3b2' : '#ff6b35';
                setTimeout(() => { throughputEl.style.color = ''; }, 1000);
            }
            
            // Punctuality improvement
            const punctualityEl = document.getElementById('punctuality');
            if (punctualityEl) {
                const current = parseFloat(punctualityEl.textContent);
                const improvement = (Math.random() - 0.3) * 3; // Slight upward bias
                const newValue = Math.max(85, Math.min(98, current + improvement));
                punctualityEl.textContent = newValue.toFixed(1) + '%';
                
                if (improvement > 0) {
                    punctualityEl.style.color = '#17c3b2';
                    setTimeout(() => { punctualityEl.style.color = ''; }, 1000);
                }
            }
            
            // Update timestamp
            updateLastUpdateTime();
        }

        // Generate demo alerts and events
        function generateDemoAlerts() {
            const alerts = [
                {message: 'AI Optimization Active', action: 'Route efficiency improved by 12%', priority: 'success'},
                {message: 'Smart Traffic Control', action: 'Automated train precedence optimized', priority: 'info'},
                {message: 'Weather Adaptation', action: 'Speed profiles adjusted for monsoon', priority: 'warning'},
                {message: 'Emergency Response Ready', action: 'All safety protocols active', priority: 'success'},
                {message: 'Predictive Analysis', action: 'Delay prevention system engaged', priority: 'info'}
            ];
            
            if (Math.random() > 0.7) { // 30% chance to show alert
                const alert = alerts[Math.floor(Math.random() * alerts.length)];
                addAlert(alert);
            }
        }

        // Demo weather updates
        function updateWeatherDemo() {
            const weatherConditions = [
                {condition: 'clear', temp: 28, icon: 'sun', impact: 1.0},
                {condition: 'partly cloudy', temp: 26, icon: 'cloud-sun', impact: 0.95},
                {condition: 'light rain', temp: 23, icon: 'cloud-rain', impact: 0.85},
                {condition: 'clear', temp: 30, icon: 'sun', impact: 1.0}
            ];
            
            const weather = weatherConditions[Math.floor(Math.random() * weatherConditions.length)];
            
            document.getElementById('weatherTemp').textContent = `${weather.temp}Â°C`;
            document.getElementById('weatherCondition').textContent = weather.condition;
            document.getElementById('weatherImpact').textContent = weather.impact.toFixed(1);
            document.getElementById('weatherIcon').className = `fas fa-${weather.icon}`;
        }

        // Update last update timestamp
        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            const updateElement = document.getElementById('lastUpdate');
            if (updateElement) {
                updateElement.textContent = timeString;
            }
        }

        // Update system status
        function updateSystemStatus(message, type) {
            const statusElement = document.getElementById('systemStatus');
            if (statusElement) {
                statusElement.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i> ${message}`;
                statusElement.className = `system-status-bar ${type === 'success' ? '' : 'alert-' + type}`;
            }
        }

        // Handle real-time updates
        function handleRealtimeUpdate(data) {
            switch(data.type) {
                case 'train_update':
                    updateTrainPosition(data.train);
                    break;
                case 'kpi_update':
                    updateKPIs(data.kpis);
                    break;
                case 'alert':
                    addAlert(data.alert);
                    break;
                case 'optimization_result':
                    displayOptimizationResult(data.result);
                    break;
                case 'weather_update':
                    updateWeather(data.weather);
                    break;
            }
        }

        // Update train position on map
        function updateTrainPosition(train) {
            if (trainMarkers[train.id]) {
                map.removeLayer(trainMarkers[train.id]);
            }

            const icon = getTrainIcon(train.type, train.status);
            const marker = L.marker([train.latitude, train.longitude], {icon: icon})
                .addTo(map)
                .bindPopup(getTrainPopupContent(train));

            trainMarkers[train.id] = marker;
        }

        // Get train icon based on type and status
        function getTrainIcon(type, status) {
            let color = '#17c3b2'; // default green
            if (status === 'delayed') color = '#dc3545';
            else if (status === 'early') color = '#ffc107';

            return L.divIcon({
                html: `<i class="fas fa-train" style="color: ${color}; font-size: 20px;"></i>`,
                iconSize: [25, 25],
                className: 'train-icon'
            });
        }

        // Get train popup content
        function getTrainPopupContent(train) {
            return `
                <div class="train-popup">
                    <h6><strong>${train.train_id}</strong></h6>
                    <p><strong>Type:</strong> ${train.type}</p>
                    <p><strong>Status:</strong> ${train.status}</p>
                    <p><strong>Speed:</strong> ${train.current_speed} km/h</p>
                    <p><strong>Delay:</strong> ${train.delay_minutes} min</p>
                    <p><strong>Next Station:</strong> ${train.next_station}</p>
                </div>
            `;
        }

        // Update KPIs
        function updateKPIs(kpis) {
            if (kpis.active_trains !== undefined) {
                document.getElementById('activeTains').textContent = kpis.active_trains;
            }
            if (kpis.punctuality !== undefined) {
                document.getElementById('punctuality').textContent = kpis.punctuality.toFixed(1) + '%';
            }
            if (kpis.avg_delay !== undefined) {
                document.getElementById('avgDelay').textContent = kpis.avg_delay.toFixed(1);
            }
            if (kpis.throughput !== undefined) {
                document.getElementById('throughput').textContent = kpis.throughput.toFixed(1);
            }
            if (kpis.efficiency !== undefined) {
                document.getElementById('efficiency').textContent = kpis.efficiency.toFixed(1) + '%';
            }
            if (kpis.utilization !== undefined) {
                document.getElementById('utilization').textContent = kpis.utilization.toFixed(1) + '%';
            }
        }

        // Add alert to alerts panel
        function addAlert(alert) {
            const alertsContainer = document.getElementById('alertsList');
            const alertElement = document.createElement('div');
            alertElement.className = `alert-item alert-${alert.priority}`;
            alertElement.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>${alert.message}</strong>
                        <br><small>${alert.action}</small>
                    </div>
                    <small class="text-muted">${new Date().toLocaleTimeString()}</small>
                </div>
            `;
            alertsContainer.insertBefore(alertElement, alertsContainer.firstChild);

            // Update alert count
            const alertCount = document.getElementById('alertCount');
            alertCount.textContent = parseInt(alertCount.textContent) + 1;

            // Remove old alerts (keep only last 10)
            while (alertsContainer.children.length > 10) {
                alertsContainer.removeChild(alertsContainer.lastChild);
            }
        }

        // Load active trains
        function loadActiveTrains() {
            // Simulate loading active trains
            const trainsList = document.getElementById('activeTrainsList');
            const sampleTrains = [
                {id: 'EXP001', type: 'express', status: 'on-time', delay: 0},
                {id: 'LOC002', type: 'local', status: 'delayed', delay: 5},
                {id: 'FRT003', type: 'freight', status: 'early', delay: -2},
                {id: 'EXP004', type: 'express', status: 'on-time', delay: 1},
                {id: 'LOC005', type: 'local', status: 'delayed', delay: 8}
            ];

            trainsList.innerHTML = '';
            sampleTrains.forEach(train => {
                const trainCard = document.createElement('div');
                trainCard.className = `card train-card train-${train.type}`;
                trainCard.innerHTML = `
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="status-indicator status-${train.status.replace('-', '')}"></span>
                                <strong>${train.id}</strong>
                                <small class="text-muted d-block">${train.type.toUpperCase()}</small>
                            </div>
                            <div class="text-end">
                                <div class="text-${train.delay > 0 ? 'danger' : train.delay < 0 ? 'warning' : 'success'}">
                                    ${train.delay > 0 ? '+' : ''}${train.delay} min
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                trainsList.appendChild(trainCard);
            });
        }

        // Load alerts
        function loadAlerts() {
            const sampleAlerts = [
                {message: 'Train EXP001 approaching capacity limit', action: 'Consider platform reallocation', priority: 'high'},
                {message: 'Weather impact detected on Section B', action: 'Reduce speed limits by 20%', priority: 'medium'},
                {message: 'Optimization complete - 15% improvement', action: 'Review recommendations', priority: 'low'}
            ];

            sampleAlerts.forEach(alert => addAlert(alert));
        }

        // Update system status
        function updateSystemStatus(message, type) {
            const statusBar = document.getElementById('systemStatus');
            const iconClass = type === 'success' ? 'check-circle' : 
                             type === 'warning' ? 'exclamation-triangle' : 'times-circle';
            
            statusBar.innerHTML = `<i class="fas fa-${iconClass}"></i> ${message} | Last Update: <span id="lastUpdate">${new Date().toLocaleTimeString()}</span>`;
            statusBar.className = `system-status-bar alert-${type}`;
        }

        // Update timestamp
        function updateTimestamp() {
            const updateElement = document.getElementById('lastUpdate');
            if (updateElement) {
                updateElement.textContent = new Date().toLocaleTimeString();
            }
        }

        // Refresh all data
        function refreshData() {
            // Simulate data refresh
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({type: 'request_update'}));
            }
        }

        // Refresh map
        function refreshMap() {
            map.invalidateSize();
            // Simulate new train positions
            const samplePositions = [
                {id: 'EXP001', latitude: 28.6189, longitude: 77.2120, type: 'express', status: 'on-time'},
                {id: 'LOC002', latitude: 28.6319, longitude: 77.2200, type: 'local', status: 'delayed'},
                {id: 'FRT003', latitude: 28.6469, longitude: 77.2280, type: 'freight', status: 'on-time'}
            ];

            samplePositions.forEach(updateTrainPosition);
        }

        // Run optimization
        function runOptimization() {
            document.getElementById('loadingSpinner').style.display = 'block';
            
            setTimeout(() => {
                document.getElementById('loadingSpinner').style.display = 'none';
                addAlert({
                    message: 'Optimization completed successfully',
                    action: '18% improvement in throughput achieved',
                    priority: 'low'
                });
                
                // Update optimization metrics
                document.getElementById('solveTime').textContent = '2.1s';
                document.getElementById('confidence').textContent = 'High (96%)';
                document.getElementById('lastOptimized').textContent = 'Just now';
            }, 3000);
        }

        // View recommendations
        function viewRecommendations() {
            alert('Recommendations:\n\n1. Delay LOC002 by 3 minutes for optimal spacing\n2. Increase EXP001 speed to 85% on Segment B\n3. Allocate Platform 2 for incoming FRT003');
        }

        // Emergency controls
        function emergencyStop() {
            if (confirm('Are you sure you want to initiate emergency stop for all trains?')) {
                addAlert({
                    message: 'EMERGENCY STOP ACTIVATED',
                    action: 'All trains have been signaled to stop immediately',
                    priority: 'high'
                });
            }
        }

        function systemMaintenance() {
            if (confirm('Enable maintenance mode? This will restrict train operations.')) {
                addAlert({
                    message: 'Maintenance mode activated',
                    action: 'System operating in restricted mode',
                    priority: 'medium'
                });
            }
        }

        function weatherAlert() {
            addAlert({
                message: 'Weather alert issued',
                action: 'Monitoring weather conditions for all sections',
                priority: 'medium'
            });
        }

        // Update weather widget
        function updateWeather(weather) {
            document.getElementById('weatherTemp').textContent = weather.temperature + 'Â°C';
            document.getElementById('weatherCondition').textContent = weather.condition;
            document.getElementById('weatherImpact').textContent = weather.impact_factor;
            
            const iconMap = {
                'clear': 'sun',
                'cloudy': 'cloud',
                'rainy': 'cloud-rain',
                'stormy': 'bolt'
            };
            
            document.getElementById('weatherIcon').className = `fas fa-${iconMap[weather.condition] || 'sun'}`;
        }
    </script>
</body>
</html>
